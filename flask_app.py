from flask import Flask, request, abort
import json
import bot # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –í–ê–® —Ñ–∞–π–ª bot.py
import os
# –ò—Å–ø–æ–ª—å–∑—É–µ–º os –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è —Ç–æ–∫–µ–Ω–∞)

app = Flask(__name__)

# --- ‚ö†Ô∏è –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –í–ï–ë–•–£–ö–ê ‚ö†Ô∏è ---

# URL –≤–∞—à–µ–≥–æ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ PythonAnywhere (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å HTTPS)
WEBHOOK_URL = "https://REPTILOIDKRUCHEVSEH.pythonanywhere.com/"

# –°–µ–∫—Ä–µ—Ç–Ω—ã–π –ø—É—Ç—å –¥–ª—è –≤–µ–±—Ö—É–∫–∞. Telegram –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—é–¥–∞.
# –ò–∑–º–µ–Ω–∏—Ç–µ 'MySecretWebHookPath' –Ω–∞ –ª—é–±–æ–µ —Å–≤–æ–µ —Å–µ–∫—Ä–µ—Ç–Ω–æ–µ —Å–ª–æ–≤–æ –∏–ª–∏ —Ñ—Ä–∞–∑—É.
WEBHOOK_URL_PATH = "/MySecretWebHookPath"

# –ü–æ–ª–Ω—ã–π URL, –∫–æ—Ç–æ—Ä—ã–π –º—ã —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤ Telegram: WEBHOOK_URL + WEBHOOK_URL_PATH
FULL_WEBHOOK_URL = WEBHOOK_URL.rstrip('/') + WEBHOOK_URL_PATH

# --- ‚ö†Ô∏è –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ‚ö†Ô∏è ---

# –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –≤–µ–±—Ö—É–∫ –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
try:
    # –í–∞–∂–Ω–æ: –ù–∞ PythonAnywhere —ç—Ç–æ—Ç –∫–æ–¥ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ
    # –∏ –¥–æ–ª–∂–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å.
    bot.bot.remove_webhook()
    bot.bot.set_webhook(url=FULL_WEBHOOK_URL)
    print(f"‚úÖ –í–µ–±—Ö—É–∫ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞: {FULL_WEBHOOK_URL}")
except Exception as e:
    # –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –≤–µ–±—Ö—É–∫–∞ –Ω–µ –¥–æ–ª–∂–Ω–∞ –ø—Ä–µ—Ä—ã–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É Flask
    print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –≤–µ–±—Ö—É–∫–∞: {e}")


# --- üì¨ –†–û–£–¢–´ –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ---

# –†–æ—É—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Ö–æ–¥—è—â–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –æ—Ç Telegram (POST-–∑–∞–ø—Ä–æ—Å—ã)
# –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –ø—É—Ç—å, —á—Ç–æ–±—ã –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Ç–æ–ª—å–∫–æ –∑–∞–ø—Ä–æ—Å—ã –æ—Ç Telegram
@app.route(WEBHOOK_URL_PATH, methods=["POST"])
def webhook():
    # –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —ç—Ç–æ –∑–∞–ø—Ä–æ—Å –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON
    if request.headers.get("content-type") == "application/json":
        json_string = request.get_data().decode("utf-8")
        update = bot.telebot.types.Update.de_json(json_string)

        # –ü–µ—Ä–µ–¥–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç—É –±–æ—Ç–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
        bot.bot.process_new_updates([update])

        return "OK", 200 # Telegram –æ–∂–∏–¥–∞–µ—Ç 200 OK
    else:
        # –ï—Å–ª–∏ —Ñ–æ—Ä–º–∞—Ç –Ω–µ JSON, –æ—Ç–∫–ª–æ–Ω—è–µ–º. –≠—Ç–æ –Ω–µ –∑–∞–ø—Ä–æ—Å –æ—Ç Telegram.
        abort(403)


# –†–æ—É—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ (GET-–∑–∞–ø—Ä–æ—Å—ã)
# –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ—Ä–Ω–µ–≤–æ–π –ø—É—Ç—å ('/') –¥–ª—è —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
@app.route("/", methods=["GET"])
def index():
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–µ–±—Ö—É–∫–∞
        webhook_info = bot.bot.get_webhook_info()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–≤–ø–∞–¥–∞–µ—Ç –ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π URL —Å –æ–∂–∏–¥–∞–µ–º—ã–º –ø–æ–ª–Ω—ã–º URL
        if webhook_info.url == FULL_WEBHOOK_URL:
            return "‚úÖ Bot is running! Webhook is set correctly.", 200
        else:
            return f"‚ö†Ô∏è Bot is running, but webhook is NOT set correctly. Current: {webhook_info.url}. Expected: {FULL_WEBHOOK_URL}", 200
    except Exception as e:
        # –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤–µ–±—Ö—É–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–æ–±–ª–µ–º—ã —Å —Ç–æ–∫–µ–Ω–æ–º)
        return f"‚ö†Ô∏è Bot is running, but connection check failed. Error: {e}", 200

# –≠—Ç–æ —É—Å–ª–æ–≤–∏–µ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ PythonAnywhere, —Ç–∞–∫ –∫–∞–∫ WSGI-—Å–µ—Ä–≤–µ—Ä
# –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞–ø—Ä—è–º—É—é. –ù–æ –æ–Ω–æ –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
if __name__ == "__main__":
    app.run(debug=True)